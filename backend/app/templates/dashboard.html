{% extends "base.html" %}
{% block content %}
<!-- å®æ—¶è´¦æˆ·ä¿¡æ¯ -->
<div class="card" style="margin-bottom:1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <div class="card-content">
        <div class="columns is-vcentered">
            <div class="column">
                <p class="heading" style="color: rgba(255,255,255,0.8);">èµ„é‡‘è´¦æˆ·ï¼ˆèµ„äº§æ€»é¢ï¼‰/ Wallet (Total Assets)</p>
                <p class="title is-5" id="wallet-balance" style="color: white; font-size: 1.2rem;">åŠ è½½ä¸­...</p>
                <p class="help" style="color: rgba(255,255,255,0.6); font-size: 0.75rem;">sapi/v3/asset/getUserAsset</p>
            </div>
            <div class="column">
                <p class="heading" style="color: rgba(255,255,255,0.8);">ç°è´§è´¦æˆ· / Spot</p>
                <p class="title is-5" id="spot-balance" style="color: white; font-size: 1.2rem;">åŠ è½½ä¸­...</p>
                <p class="help" style="color: rgba(255,255,255,0.6); font-size: 0.75rem;">api/v3/account</p>
            </div>
            <div class="column">
                <p class="heading" style="color: rgba(255,255,255,0.8);">åˆçº¦è´¦æˆ· / Futures</p>
                <p class="title is-5" id="futures-balance" style="color: white; font-size: 1.2rem;">åŠ è½½ä¸­...</p>
                <p class="help" style="color: rgba(255,255,255,0.6); font-size: 0.75rem;">fapi/v2/balance</p>
            </div>
            <div class="column">
                <p class="heading" style="color: rgba(255,255,255,0.8);">æ€»ç›ˆäº / P&L</p>
                <p class="title is-5" id="total-pnl" style="color: white; font-size: 1.2rem;">åŠ è½½ä¸­...</p>
            </div>
            <div class="column">
                <p class="heading" style="color: rgba(255,255,255,0.8);">æ´»è·ƒæŒä»“ / Positions</p>
                <p class="title is-5" id="position-count" style="color: white; font-size: 1.2rem;">0</p>
            </div>
            <div class="column">
                <p class="heading" style="color: rgba(255,255,255,0.8);">æœ€åæ›´æ–° / Updated</p>
                <p class="title is-6" id="last-update" style="color: white;">--</p>
            </div>
            <div class="column">
                <p class="heading" style="color: rgba(255,255,255,0.8);">UTC æ—¶é—´ / UTC Time</p>
                <p class="title is-6" id="utc-time" style="color: white; font-family: 'Courier New', monospace;">--</p>
            </div>
        </div>
    </div>
</div>

<!-- å®æ—¶æŒä»“åˆ—è¡¨ -->
<div class="card" style="margin-bottom:1rem;" id="positions-card">
    <header class="card-header">
        <p class="card-header-title">å®æ—¶æŒä»“ / Real-time Positions <span id="positions-badge" class="tag is-primary">0</span></p>
        <button class="button is-small is-light" onclick="refreshDashboard()" style="margin: 0.5rem;">åˆ·æ–° / Refresh</button>
    </header>
    <div class="card-content">
        <div id="positions-container" style="transition: opacity 0.2s ease-in-out;">
            <p class="has-text-grey">åŠ è½½ä¸­... / Loading...</p>
        </div>
    </div>
</div>

<!-- æ”¶ç›Šæ¦‚è§ˆ -->
<div class="card" style="margin-bottom:1rem;" id="pnl-card">
    <header class="card-header">
        <p class="card-header-title">æ”¶ç›Šæ¦‚è§ˆ / PnL Summary</p>
        <span class="tag is-light">æœ€è¿‘ <span id="pnl-days-label">--</span> å¤©</span>
    </header>
    <div class="card-content">
        <div class="columns is-multiline">
            <div class="column is-one-quarter">
                <p class="heading">ç´¯è®¡æ”¶ç›Š / Total</p>
                <p class="title is-4" id="pnl-total">--</p>
            </div>
            <div class="column is-one-quarter">
                <p class="heading">ä»Šæ—¥æ”¶ç›Š / Today</p>
                <p class="title is-4" id="pnl-today">--</p>
            </div>
            <div class="column">
                <p class="heading">æœ€è¿‘æ¯æ—¥æ”¶ç›Š / Recent Daily PnL</p>
                <div id="pnl-daily-list" class="pnl-daily-list has-text-grey">
                    åŠ è½½ä¸­...
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card" style="margin-bottom:1rem;">
    <header class="card-header">
        <p class="card-header-title">æ‰‹åŠ¨ä¸‹å•è®¡åˆ’ / Manual Trading Plans</p>
    </header>
    <div class="card-content">
        <form method="post" action="/manual-plans" class="columns is-multiline">
            <div class="column is-one-quarter">
                <label class="label">åˆçº¦ç¬¦å· / Symbol</label>
                <input class="input" name="symbol" placeholder="å¦‚ BTC (ä¼šè‡ªåŠ¨æ·»åŠ USDT) / e.g. BTC" required>
                <p class="help">åªéœ€è¾“å…¥å¸ç§ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ USDT</p>
            </div>
            <div class="column is-one-quarter">
                <label class="label">æ–¹å‘ / Side</label>
                <div class="select is-fullwidth">
                    <select name="side">
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                    </select>
                </div>
            </div>
            <div class="column is-one-quarter">
                <label class="label">ä¸Šçº¿æ—¶é—´ (UTC) / Listing Time</label>
                <input class="input" name="listing_time" placeholder="2024-11-15T10:30:00Z" required>
                <p class="help">ä½¿ç”¨UTCæ—¶é—´ï¼Œæ ¼å¼ï¼šYYYY-MM-DDTHH:MM:SSZ / UTC time format</p>
            </div>
            <div class="column is-one-quarter">
                <label class="label">æ æ† / Leverage</label>
                <input class="input" name="leverage" value="{{ default_leverage }}" type="number" step="1" min="1" max="125" required>
            </div>
            <div class="column is-one-quarter">
                <label class="label">ä»“ä½æ¯”ä¾‹ / Position %</label>
                <input class="input" name="position_pct" value="{{ default_position_pct }}" type="number" step="0.01" min="0.01" max="1" required>
                <p class="help">ä½¿ç”¨å¯ç”¨ä¿è¯é‡‘çš„ç™¾åˆ†æ¯” (0.5 = 50%) / % of available margin</p>
            </div>
            <div class="column is-one-quarter">
                <label class="label">æ»‘åŠ¨é€€å‡º% / Trailing Exit %</label>
                <input class="input" name="trailing_exit_pct" value="{{ default_trailing_exit_pct }}" type="number" step="0.01" min="0" max="1" required>
                <p class="help">ä»æœ€é«˜ä»·å›æ’¤çš„ç™¾åˆ†æ¯” (0.15 = 15%) / % pullback from high</p>
            </div>
            <div class="column is-one-quarter">
                <label class="label">æ­¢æŸ% / Stop Loss %</label>
                <input class="input" name="stop_loss_pct" value="{{ default_stop_loss_pct }}" type="number" step="0.01" min="0" max="1" required>
                <p class="help">ä»å…¥åœºä»·ä¸‹è·Œçš„ç™¾åˆ†æ¯” (0.05 = 5%) / % drop from entry</p>
            </div>
            <div class="column is-full">
                <label class="label">å¤‡æ³¨ / Notes</label>
                <textarea class="textarea" name="notes" placeholder="å¯ç•™ç©ºï¼Œç”¨äºè®°å½•æµ‹è¯•ä¿¡æ¯ç­‰ / Optional notes"></textarea>
            </div>
            <div class="column is-full">
                <button class="button is-primary" type="submit">åˆ›å»ºæ‰‹åŠ¨è®¡åˆ’ / Create Plan</button>
                <p class="help" style="margin-top: 0.5rem;">
                    <strong>æç¤º / Tip:</strong> ç³»ç»Ÿä¼šåœ¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨æ‰§è¡Œè®¢å•ã€‚å¦‚æœé…ç½®äº† MAX_ORDER_AMOUNTï¼Œå•ç¬”è®¢å•ä¸ä¼šè¶…è¿‡è¯¥é™åˆ¶ã€‚ / System will auto-execute at specified time. MAX_ORDER_AMOUNT limit applies if configured.
                </p>
            </div>
        </form>
    </div>
</div>

<!-- ç³»ç»Ÿé…ç½® / System Settings -->
<div class="card" style="margin-bottom:1rem;">
    <header class="card-header">
        <p class="card-header-title">ç³»ç»Ÿé…ç½® / System Settings</p>
        <button class="button is-small is-light" onclick="loadSettings()" style="margin: 0.5rem;">åˆ·æ–°é…ç½® / Refresh</button>
    </header>
    <div class="card-content">
        <div id="settings-message" class="notification" style="display:none; margin-bottom:1rem;"></div>
        <form id="settings-form" onsubmit="updateSettings(event)">
            <div class="columns is-multiline">
                <div class="column is-one-quarter">
                    <label class="label">è®¢å•ç±»å‹ / Order Type</label>
                    <div class="select is-fullwidth">
                        <select id="order_type" name="order_type" required>
                            <option value="MARKET">MARKET (å¸‚ä»·å•)</option>
                            <option value="LIMIT">LIMIT (é™ä»·å•)</option>
                        </select>
                    </div>
                    <p class="help">å¸‚ä»·å•æˆäº¤å¿«ä½†å¯èƒ½æœ‰æ»‘ç‚¹ï¼Œé™ä»·å•å¯æ§åˆ¶ä»·æ ¼ä½†å¯èƒ½ä¸æˆäº¤</p>
                </div>
                <div class="column is-one-quarter">
                    <label class="label">æœ€å¤§æ»‘ç‚¹% / Max Slippage %</label>
                    <input class="input" id="max_slippage_pct" name="max_slippage_pct" type="number" step="0.01" min="0" required>
                    <p class="help">ä»…å¯¹å¸‚ä»·å•æœ‰æ•ˆï¼Œè¶…è¿‡æ­¤å€¼ä¼šè®°å½•è­¦å‘Š</p>
                </div>
                <div class="column is-one-quarter">
                    <label class="label">é™ä»·å•è¶…æ—¶(ç§’) / Limit Order Timeout (s)</label>
                    <input class="input" id="limit_order_timeout_seconds" name="limit_order_timeout_seconds" type="number" step="1" min="0" required>
                    <p class="help">é™ä»·å•è¶…æ—¶åè‡ªåŠ¨è½¬ä¸ºå¸‚ä»·å•</p>
                </div>
                <div class="column is-one-quarter">
                    <label class="label">æœ€å¤§è®¢å•é‡‘é¢(USDT) / Max Order Amount (USDT)</label>
                    <input class="input" id="max_order_amount" name="max_order_amount" type="number" step="0.01" min="0" placeholder="0è¡¨ç¤ºæ— é™åˆ¶">
                    <p class="help">å•ç¬”è®¢å•æœ€å¤§è´­ä¹°é‡‘é¢ï¼Œ0è¡¨ç¤ºä¸é™åˆ¶</p>
                </div>
                <div class="column is-one-quarter">
                    <label class="label">é»˜è®¤æ æ† / Default Leverage</label>
                    <input class="input" id="leverage" name="leverage" type="number" step="1" min="1" max="125" required>
                </div>
                <div class="column is-one-quarter">
                    <label class="label">ä»“ä½æ¯”ä¾‹ / Position %</label>
                    <input class="input" id="position_pct" name="position_pct" type="number" step="0.01" min="0.01" max="1" required>
                    <p class="help">ä½¿ç”¨å¯ç”¨ä¿è¯é‡‘çš„ç™¾åˆ†æ¯” (0.5 = 50%)</p>
                </div>
                <div class="column is-one-quarter">
                    <label class="label">æ»‘åŠ¨é€€å‡º% / Trailing Exit %</label>
                    <input class="input" id="trailing_exit_pct" name="trailing_exit_pct" type="number" step="0.01" min="0" max="1" required>
                    <p class="help">ä»æœ€é«˜ä»·å›æ’¤çš„ç™¾åˆ†æ¯” (0.15 = 15%)</p>
                </div>
                <div class="column is-one-quarter">
                    <label class="label">æ­¢æŸ% / Stop Loss %</label>
                    <input class="input" id="stop_loss_pct" name="stop_loss_pct" type="number" step="0.01" min="0" max="1" required>
                    <p class="help">ä»å…¥åœºä»·ä¸‹è·Œçš„ç™¾åˆ†æ¯” (0.05 = 5%)</p>
                </div>
                <div class="column is-full">
                    <button class="button is-primary" type="submit">ä¿å­˜é…ç½® / Save Settings</button>
                    <p class="help" style="margin-top: 0.5rem;">
                        <strong>æ³¨æ„ / Note:</strong> é…ç½®ä¿å­˜åéœ€è¦é‡å¯æœåŠ¡æ‰èƒ½å®Œå…¨ç”Ÿæ•ˆ / Settings require service restart to take full effect
                    </p>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- å†å²æ“ä½œè®°å½•é“¾æ¥ -->
<div class="card" style="margin-bottom:1rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
    <div class="card-content">
        <div class="columns is-vcentered">
            <div class="column">
                <p class="title is-5" style="color: white; margin-bottom: 0.8rem;">
                    ğŸ“Š äº¤æ˜“å†å²è®°å½• / Trading History
                </p>
                <p class="subtitle is-6" style="color: rgba(255,255,255,0.9); margin-bottom: 0.5rem; line-height: 1.4;">
                    æŸ¥çœ‹æ‰€æœ‰ä¹°å…¥ã€é€€å‡ºè®°å½•åŠé€€å‡ºæ¡ä»¶ï¼Œä¾¿äºå¤ç›˜å’Œè°ƒæ•´ç­–ç•¥å‚æ•°
                </p>
                <p class="subtitle is-6" style="color: rgba(255,255,255,0.9); line-height: 1.4;">
                    View all buy/sell records and exit conditions for strategy review and parameter adjustment
                </p>
            </div>
            <div class="column is-narrow">
                <a href="/history" class="button is-large is-white is-outlined">
                    <span class="icon">
                        <i class="fas fa-history"></i>
                    </span>
                    <span>æŸ¥çœ‹å†å²è®°å½• / View History</span>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 1rem;">
    <header class="card-header">
                <p class="card-header-title">æ‰‹åŠ¨è®¡åˆ’åˆ—è¡¨ / Manual Plans List (<span id="manual-plans-count">{{ manual_plans|length }}</span>)</p>
    </header>
    <div class="card-content scroll-box" id="manual-plans-container">
        {% if manual_plans %}
            <table class="table is-fullwidth is-striped is-narrow">
                <thead>
                <tr>
                    <th>ç¬¦å· / Symbol</th>
                    <th>æ–¹å‘ / Side</th>
                    <th>ä¸Šçº¿æ—¶é—´ / Listing Time</th>
                    <th>æ æ† / Leverage</th>
                    <th>ä»“ä½% / Position %</th>
                    <th>çŠ¶æ€ / Status</th>
                    <th>æ“ä½œ / Action</th>
                </tr>
                </thead>
                <tbody id="manual-plans-tbody">
                {% for plan in manual_plans %}
                    <tr>
                        <td>{{ plan.symbol }}</td>
                        <td>{{ plan.side }}</td>
                        <td>{{ plan.listing_time }}</td>
                        <td>{{ plan.leverage }}</td>
                        <td>{{ plan.position_pct }}</td>
                        <td>{{ plan.status.value }}</td>
                        <td>
                            {% if plan.status.value in ['PENDING','ARMED','EXECUTING'] %}
                            <form method="post" action="/manual-plans/{{ plan.id }}/cancel">
                                <button class="button is-small is-light" type="submit">å–æ¶ˆ / Cancel</button>
                            </form>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>æš‚æ— æ‰‹åŠ¨è®¡åˆ’ / No manual plans</p>
        {% endif %}
    </div>
</div>

<script>
let refreshInterval;
let currentRefreshRate = 1000; // é»˜è®¤1ç§’åˆ·æ–°
const HIGH_FREQ_RATE = 200; // é«˜é¢‘åˆ·æ–°ï¼š200æ¯«ç§’ï¼ˆæœ‰æŒä»“æˆ–ä¸´è¿‘äº¤æ˜“æ—¶ï¼Œä»…HTTP fallbackæ¨¡å¼ï¼‰
const NORMAL_RATE = 1000; // æ­£å¸¸åˆ·æ–°ï¼š1ç§’ï¼ˆæ— æŒä»“ä¸”æ— ä¸´è¿‘äº¤æ˜“æ—¶ï¼Œä»…HTTP fallbackæ¨¡å¼ï¼‰
const PNL_SUMMARY_DAYS = 14;
const PNL_REFRESH_INTERVAL = 60000; // 60ç§’åˆ·æ–°æ”¶ç›Šæ‘˜è¦
let pnlRefreshTimer = null;

// æ··åˆæ¨¡å¼çš„åˆ·æ–°é¢‘ç‡é…ç½®
const HTTP_REFRESH_RATE_WS_CONNECTED = 1000; // WebSocketè¿æ¥æ—¶ï¼ŒHTTPè½®è¯¢é¢‘ç‡ï¼ˆ1ç§’ï¼Œåªæ›´æ–°ä½™é¢å’Œæ‰‹åŠ¨è®¡åˆ’ï¼‰
const HTTP_REFRESH_RATE_WS_DISCONNECTED = 1000; // WebSocketæœªè¿æ¥æ—¶ï¼ŒHTTPè½®è¯¢é¢‘ç‡ï¼ˆ1ç§’ï¼Œæ›´æ–°æ‰€æœ‰æ•°æ®ï¼‰

// WebSocketè¿æ¥
let ws = null;
let wsReconnectAttempts = 0;
const MAX_WS_RECONNECT_ATTEMPTS = 5;
let lastWebSocketUpdateTime = null; // è®°å½•ä¸Šæ¬¡WebSocketæ›´æ–°æ—¶é—´

// æ ¼å¼åŒ–æ•°å­—
function formatNumber(num, decimals = 3) {
    return parseFloat(num).toFixed(decimals);
}

// æ ¼å¼åŒ–ç™¾åˆ†æ¯”
function formatPercent(num) {
    const sign = num >= 0 ? '+' : '';
    return sign + formatNumber(num, 2) + '%';
}

function formatCurrency(num, decimals = 2) {
    if (isNaN(num)) {
        return '--';
    }
    const sign = num >= 0 ? '+' : '';
    return `${sign}${formatNumber(Math.abs(num), decimals)} USDT`;
}

// æ›´æ–°è´¦æˆ·ä¿¡æ¯
function updateAccountInfo(data) {
    const account = data.account || {};
    
    // æ›´æ–°èµ„é‡‘è´¦æˆ·ä½™é¢ï¼ˆç²¾ç¡®åˆ°å°æ•°ç‚¹å3ä½ï¼‰
    // sapi/v3/asset/getUserAsset - é’±åŒ…æ€»èµ„äº§ï¼ˆæ‰€æœ‰è´¦æˆ·çš„æ€»å’Œï¼‰
    const walletBalanceElement = document.getElementById('wallet-balance');
    if (walletBalanceElement && account.wallet_balance !== undefined) {
        const walletBalance = account.wallet_balance || 0;
        walletBalanceElement.textContent = formatNumber(walletBalance, 3) + ' USDT';
        walletBalanceElement.title = 'èµ„é‡‘è´¦æˆ·ä½™é¢ï¼ˆé’±åŒ…æ€»èµ„äº§ï¼Œæ‰€æœ‰è´¦æˆ·çš„æ€»å’Œï¼‰API: sapi/v3/asset/getUserAsset';
        walletBalanceElement.style.color = 'white';
    }
    
    // æ›´æ–°ç°è´§è´¦æˆ·ä½™é¢ï¼ˆç²¾ç¡®åˆ°å°æ•°ç‚¹å3ä½ï¼‰
    // api/v3/account - ç°è´§äº¤æ˜“è´¦æˆ·ä½™é¢
    const spotBalanceElement = document.getElementById('spot-balance');
    if (spotBalanceElement && account.spot_balance !== undefined) {
        const spotBalance = account.spot_balance || 0;
        spotBalanceElement.textContent = formatNumber(spotBalance, 3) + ' USDT';
        spotBalanceElement.title = 'ç°è´§è´¦æˆ·ä½™é¢ API: api/v3/account';
        spotBalanceElement.style.color = 'white';
    }
    
    // æ›´æ–°åˆçº¦è´¦æˆ·ä½™é¢ï¼ˆç²¾ç¡®åˆ°å°æ•°ç‚¹å3ä½ï¼‰
    // fapi/v2/balance - åˆçº¦äº¤æ˜“è´¦æˆ·å¯ç”¨ä½™é¢
    const futuresBalanceElement = document.getElementById('futures-balance');
    if (futuresBalanceElement && (account.futures_balance !== undefined || account.balance !== undefined)) {
        const futuresBalance = account.futures_balance || account.balance || 0;
        futuresBalanceElement.textContent = formatNumber(futuresBalance, 3) + ' USDT';
        futuresBalanceElement.title = 'åˆçº¦è´¦æˆ·ä½™é¢ï¼ˆå¯ç”¨ä½™é¢ï¼‰API: fapi/v2/balance';
        futuresBalanceElement.style.color = 'white';
    }
    
    // æ›´æ–°æ€»ç›ˆäºï¼ˆæ··åˆæ¨¡å¼ï¼šWebSocketè¿æ¥æ—¶ä¸æ›´æ–°ï¼Œç”±WebSocketå¤„ç†ï¼‰
    const wsConnected = ws && ws.readyState === WebSocket.OPEN;
    if (!wsConnected && account.total_pnl !== undefined) {
        // åªåœ¨WebSocketæœªè¿æ¥æ—¶æ›´æ–°PnLï¼ˆä½œä¸ºfallbackï¼‰
        updatePnlValue(account.total_pnl, 'http');
    }
    // æ³¨æ„ï¼šå¦‚æœWebSocketå·²è¿æ¥ï¼ŒPnLç”±WebSocketçš„onmessageå¤„ç†
    
    document.getElementById('position-count').textContent = data.position_count || 0;
    document.getElementById('last-update').textContent = new Date().toLocaleTimeString('zh-CN');
}

async function loadPnlSummary(days = PNL_SUMMARY_DAYS) {
    try {
        const response = await fetch(`/api/pnl/summary?days=${days}`, {
            method: 'GET',
            cache: 'no-cache'
        });
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        updatePnlSummaryCard(data);
    } catch (error) {
        console.error('åŠ è½½æ”¶ç›Šæ¦‚è¦å¤±è´¥:', error);
        const listEl = document.getElementById('pnl-daily-list');
        if (listEl) {
            listEl.classList.add('has-text-danger');
            listEl.textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯• / Load failed, please retry';
        }
    }
}

function updatePnlSummaryCard(data) {
    if (!data) {
        return;
    }
    const totalEl = document.getElementById('pnl-total');
    const todayEl = document.getElementById('pnl-today');
    const daysLabel = document.getElementById('pnl-days-label');
    const listEl = document.getElementById('pnl-daily-list');
    
    if (totalEl && typeof data.total_pnl === 'number') {
        totalEl.textContent = formatCurrency(data.total_pnl);
        totalEl.className = data.total_pnl >= 0 ? 'has-text-success' : 'has-text-danger';
    }
    if (todayEl && typeof data.today_pnl === 'number') {
        todayEl.textContent = formatCurrency(data.today_pnl);
        todayEl.className = data.today_pnl >= 0 ? 'has-text-success' : 'has-text-danger';
    }
    if (daysLabel && typeof data.days === 'number') {
        daysLabel.textContent = data.days;
    }
    
    if (listEl) {
        listEl.innerHTML = '';
        if (data.daily && data.daily.length > 0) {
            data.daily.slice(-10).forEach(item => {
                const value = typeof item.pnl === 'number' ? item.pnl : 0;
                const span = document.createElement('div');
                span.innerHTML = `<span>${item.date}</span> <span class="${value >= 0 ? 'pnl-positive' : 'pnl-negative'}">${formatCurrency(value)}</span>`;
                listEl.appendChild(span);
            });
            listEl.classList.remove('has-text-danger');
        } else {
            listEl.textContent = 'æš‚æ— å†å²è®°å½• / No data';
        }
    }
}

// æ›´æ–°UTCæ—¶é—´æ˜¾ç¤º
function updateUTCTime() {
    const now = new Date();
    const utcTime = now.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
    const utcTimeElement = document.getElementById('utc-time');
    if (utcTimeElement) {
        utcTimeElement.textContent = utcTime;
    }
}

// ç¼“å­˜ä¸Šä¸€æ¬¡çš„æŒä»“æ•°æ®ï¼Œç”¨äºå¢é‡æ›´æ–°
let lastPositionsMap = new Map(); // id -> position data
let positionsTable = null; // ç¼“å­˜çš„è¡¨æ ¼DOMå¼•ç”¨

// PnLæ›´æ–°é”å’Œç¼“å­˜ï¼ˆé˜²æ­¢WebSocketå’ŒHTTPå†²çªï¼‰
let isUpdatingPnl = false;
let lastPnlValue = null;

// ç»Ÿä¸€çš„PnLæ›´æ–°å‡½æ•°ï¼ˆé˜²æ­¢WebSocketå’ŒHTTPå†²çªï¼‰
function updatePnlValue(pnl, source = 'http') {
    // é˜²æ­¢å¹¶å‘æ›´æ–°
    if (isUpdatingPnl) {
        return;
    }
    
    // ç²¾åº¦æ¯”è¾ƒï¼ˆä¿ç•™3ä½å°æ•°ï¼‰
    const roundedPnl = Math.round(pnl * 1000) / 1000;
    if (lastPnlValue !== null && Math.abs(roundedPnl - lastPnlValue) < 0.001) {
        return; // å€¼æ²¡æœ‰å˜åŒ–ï¼Œä¸æ›´æ–°
    }
    
    isUpdatingPnl = true;
    lastPnlValue = roundedPnl;
    
    requestAnimationFrame(() => {
        const pnlElement = document.getElementById('total-pnl');
        if (pnlElement) {
            const currentPnlText = pnlElement.textContent.replace(' USDT', '').trim();
            const newPnlText = formatNumber(pnl, 3);
            
            // å¦‚æœå½“å‰æ˜¯"åŠ è½½ä¸­"æˆ–å€¼å‘ç”Ÿå˜åŒ–ï¼Œå°±æ›´æ–°
            if (currentPnlText === 'åŠ è½½ä¸­...' || currentPnlText === 'åŠ è½½ä¸­' || 
                currentPnlText !== newPnlText) {
                pnlElement.textContent = newPnlText + ' USDT';
                pnlElement.title = `æ€»ç›ˆäº / Total P&L: ${formatPercent(pnl)}`;
                pnlElement.style.color = pnl >= 0 ? '#23d160' : '#ff3860';
            }
        }
        isUpdatingPnl = false;
    });
}

// ========== å½»åº•é‡å†™çš„æŒä»“æ›´æ–°ç³»ç»Ÿ ==========
// ä½¿ç”¨å•ä¸€æ•°æ®æºã€ä¸¥æ ¼å»é‡ã€ä¼˜åŒ–é˜²æŠ–ã€ç²¾ç¡®ç²¾åº¦æ¯”è¾ƒï¼ˆæ”¯æŒ1%é€€å‡ºç­–ç•¥ï¼‰

let positionUpdateDebounceTimer = null;
let positionUpdateQueue = [];
let isProcessingPositionQueue = false;
// é˜²æŠ–æ—¶é—´å·²å†…è”åˆ° updatePositions å‡½æ•°ä¸­ï¼ˆ200msï¼‰

// å…¨å±€æ›´æ–°é”ï¼šç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªæŒä»“æ›´æ–°åœ¨è¿›è¡Œ
let isUpdatingPositions = false;

// æ•°æ®å¿«ç…§ï¼šç”¨äºæ¯”è¾ƒï¼Œåªæœ‰çœŸæ­£å˜åŒ–æ‰æ›´æ–°DOMï¼ˆæé«˜ç²¾åº¦ä»¥æ”¯æŒ1%çš„é€€å‡ºç­–ç•¥ï¼‰
let lastPositionsSnapshot = null;

// å½“å‰æ˜¾ç¤ºçš„æŒä»“IDé›†åˆï¼ˆç”¨äºå»é‡ï¼‰
let currentDisplayedPositionIds = new Set();

// æ›´æ–°æŒä»“åˆ—è¡¨ï¼ˆå¸å®‰é£æ ¼ä¼˜åŒ–ï¼šç§»é™¤é˜²æŠ–ï¼Œæé«˜ç²¾åº¦ï¼Œç›´æ¥æ›´æ–°ï¼‰
function updatePositions(positions) {
    // å…¨å±€é”ï¼šå¦‚æœæ­£åœ¨æ›´æ–°ï¼Œç›´æ¥è¿”å›
    if (isUpdatingPositions) {
        return;
    }
    
    // å¿«é€Ÿå»é‡å’ŒéªŒè¯
    if (!positions || !Array.isArray(positions)) {
        return;
    }
    
    // ç¬¬ä¸€æ­¥ï¼šç®€å•å»é‡ï¼ˆåŸºäºIDï¼‰
    const uniquePositionsMap = new Map();
    for (const pos of positions) {
        if (!pos || !pos.id) {
            continue;
        }
        // å¦‚æœå·²å­˜åœ¨ï¼Œä¿ç•™æœ€æ–°çš„æ•°æ®
        if (!uniquePositionsMap.has(pos.id)) {
            uniquePositionsMap.set(pos.id, pos);
        }
    }
    const uniquePositions = Array.from(uniquePositionsMap.values());
    
    // ç¬¬äºŒæ­¥ï¼šç”Ÿæˆæ•°æ®å¿«ç…§ï¼ˆæé«˜ç²¾åº¦ï¼Œå¸å®‰é£æ ¼ï¼šä»·æ ¼0.01ï¼ŒPnL 0.1%ï¼‰
    const snapshot = JSON.stringify(uniquePositions.map(p => ({
        id: p.id,
        price: Math.round((p.current_price || 0) * 100) / 100,    // ä»·æ ¼ç²¾åº¦ï¼š0.01ï¼ˆå¸å®‰é£æ ¼ï¼‰
        pnlPct: Math.round((p.pnl_pct || 0) * 1000) / 1000,      // ç›ˆäºç™¾åˆ†æ¯”ç²¾åº¦ï¼š0.1%ï¼ˆå¸å®‰é£æ ¼ï¼‰
        pnlValue: Math.round((p.pnl_value || 0) * 100) / 100      // ç›ˆäºé‡‘é¢ç²¾åº¦ï¼š0.01 USDTï¼ˆå¸å®‰é£æ ¼ï¼‰
    })).sort((a, b) => a.id.localeCompare(b.id)));
    
    // ç¬¬ä¸‰æ­¥ï¼šå¦‚æœæ•°æ®æ²¡æœ‰å®è´¨æ€§å˜åŒ–ï¼Œç›´æ¥è¿”å›ï¼ˆé¿å…ä¸å¿…è¦çš„æ›´æ–°ï¼‰
    if (lastPositionsSnapshot === snapshot) {
        return;
    }
    
    // æ›´æ–°å¿«ç…§
    lastPositionsSnapshot = snapshot;
    
    // ç¬¬å››æ­¥ï¼šå¸å®‰é£æ ¼ - ç›´æ¥æ›´æ–°ï¼Œæ— é˜²æŠ–ï¼ˆä½¿ç”¨requestAnimationFrameç¡®ä¿å¹³æ»‘ï¼‰
    requestAnimationFrame(() => {
        _updatePositionsInternal(uniquePositions);
    });
}

// å¤„ç†æ›´æ–°é˜Ÿåˆ—ï¼ˆå·²åºŸå¼ƒï¼Œç°åœ¨ç›´æ¥æ›´æ–°ï¼‰
// ä¿ç•™æ­¤å‡½æ•°ä»¥é˜²å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼Œä½†å®é™…é€»è¾‘å·²ç§»åˆ°updatePositionsä¸­
function processPositionUpdateQueue() {
    // æ­¤å‡½æ•°å·²åºŸå¼ƒï¼Œç°åœ¨ç›´æ¥ä½¿ç”¨requestAnimationFrameæ›´æ–°
    // ä¿ç•™ä»¥é˜²å…¶ä»–åœ°æ–¹è°ƒç”¨
}

// å†…éƒ¨æ›´æ–°å‡½æ•°ï¼ˆå½»åº•é‡å†™ï¼šç®€åŒ–é€»è¾‘ï¼Œå‡å°‘DOMæ“ä½œï¼‰
function _updatePositionsInternal(positions) {
    // å…¨å±€é”ï¼šè®¾ç½®æ›´æ–°æ ‡å¿—
    if (isUpdatingPositions) {
        return; // å¦‚æœå·²ç»åœ¨æ›´æ–°ï¼Œç›´æ¥è¿”å›
    }
    isUpdatingPositions = true;
    
    try {
        const container = document.getElementById('positions-container');
        const badge = document.getElementById('positions-badge');
        
        if (!container || !badge) {
            isUpdatingPositions = false;
            return;
        }
        
        // positionså·²ç»åœ¨processPositionUpdateQueueä¸­å»é‡äº†ï¼Œè¿™é‡Œå†æ¬¡ç¡®ä¿
        const uniquePositionsMap = new Map();
        for (const pos of positions) {
            if (!pos || !pos.id) {
                continue;
            }
            if (!uniquePositionsMap.has(pos.id)) {
                uniquePositionsMap.set(pos.id, pos);
            }
        }
        const uniquePositions = Array.from(uniquePositionsMap.values());
        
        // æ›´æ–°æ•°é‡å¾½ç« 
        const positionCount = uniquePositions.length;
        const currentBadgeCount = parseInt(badge.textContent) || 0;
        if (positionCount !== currentBadgeCount) {
            badge.textContent = positionCount;
        }
        
        // å¦‚æœæ— æŒä»“ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
        if (uniquePositions.length === 0) {
            if (container.querySelector('table')) {
                container.innerHTML = '<p class="has-text-grey">æš‚æ— æ´»è·ƒæŒä»“ / No active positions</p>';
                positionsTable = null;
                lastPositionsMap.clear();
                currentDisplayedPositionIds.clear();
            }
            lastPositionsSnapshot = null;
            isUpdatingPositions = false;
            return;
        }
        
        // ç”Ÿæˆæ–°çš„æŒä»“IDé›†åˆ
        const newPositionIds = new Set(uniquePositions.map(p => p.id));
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦å®Œå…¨é‡å»ºè¡¨æ ¼ï¼ˆå¦‚æœæŒä»“IDé›†åˆå‘ç”Ÿå˜åŒ–ï¼‰
        const needsRebuild = 
            !positionsTable || 
            !container.querySelector('table') ||
            newPositionIds.size !== currentDisplayedPositionIds.size ||
            Array.from(newPositionIds).some(id => !currentDisplayedPositionIds.has(id)) ||
            Array.from(currentDisplayedPositionIds).some(id => !newPositionIds.has(id));
        
        if (needsRebuild) {
            // å®Œå…¨é‡å»ºè¡¨æ ¼ï¼ˆé¿å…å¢é‡æ›´æ–°çš„å¤æ‚æ€§ï¼‰
            createPositionsTable(container, uniquePositions);
            currentDisplayedPositionIds = new Set(newPositionIds);
            lastPositionsSnapshot = JSON.stringify(uniquePositions.map(p => ({
                id: p.id,
                price: Math.round((p.current_price || 0) * 100) / 100,    // ä»·æ ¼ç²¾åº¦ï¼š0.01ï¼ˆå¸å®‰é£æ ¼ï¼‰
                pnlPct: Math.round((p.pnl_pct || 0) * 1000) / 1000,        // ç›ˆäºç™¾åˆ†æ¯”ç²¾åº¦ï¼š0.1%ï¼ˆå¸å®‰é£æ ¼ï¼‰
                pnlValue: Math.round((p.pnl_value || 0) * 100) / 100      // ç›ˆäºé‡‘é¢ç²¾åº¦ï¼š0.01 USDTï¼ˆå¸å®‰é£æ ¼ï¼‰
            })).sort((a, b) => a.id.localeCompare(b.id)));
            isUpdatingPositions = false;
            return;
        }
        
        // å¢é‡æ›´æ–°ï¼šåªæ›´æ–°å˜åŒ–çš„å•å…ƒæ ¼ï¼ˆä»…åœ¨æŒä»“IDé›†åˆä¸å˜æ—¶ï¼‰
        if (!positionsTable) {
            positionsTable = container.querySelector('table');
        }
        
        if (!positionsTable) {
            createPositionsTable(container, uniquePositions);
            currentDisplayedPositionIds = new Set(newPositionIds);
            lastPositionsSnapshot = JSON.stringify(uniquePositions.map(p => ({
                id: p.id,
                price: Math.round((p.current_price || 0) * 100) / 100,    // ä»·æ ¼ç²¾åº¦ï¼š0.01ï¼ˆå¸å®‰é£æ ¼ï¼‰
                pnlPct: Math.round((p.pnl_pct || 0) * 1000) / 1000,        // ç›ˆäºç™¾åˆ†æ¯”ç²¾åº¦ï¼š0.1%ï¼ˆå¸å®‰é£æ ¼ï¼‰
                pnlValue: Math.round((p.pnl_value || 0) * 100) / 100      // ç›ˆäºé‡‘é¢ç²¾åº¦ï¼š0.01 USDTï¼ˆå¸å®‰é£æ ¼ï¼‰
            })).sort((a, b) => a.id.localeCompare(b.id)));
            isUpdatingPositions = false;
            return;
        }
        
        const tbody = positionsTable.querySelector('tbody');
        if (!tbody) {
            createPositionsTable(container, uniquePositions);
            currentDisplayedPositionIds = new Set(newPositionIds);
            lastPositionsSnapshot = JSON.stringify(uniquePositions.map(p => ({
                id: p.id,
                price: Math.round((p.current_price || 0) * 100) / 100,    // ä»·æ ¼ç²¾åº¦ï¼š0.01ï¼ˆå¸å®‰é£æ ¼ï¼‰
                pnlPct: Math.round((p.pnl_pct || 0) * 1000) / 1000,        // ç›ˆäºç™¾åˆ†æ¯”ç²¾åº¦ï¼š0.1%ï¼ˆå¸å®‰é£æ ¼ï¼‰
                pnlValue: Math.round((p.pnl_value || 0) * 100) / 100      // ç›ˆäºé‡‘é¢ç²¾åº¦ï¼š0.01 USDTï¼ˆå¸å®‰é£æ ¼ï¼‰
            })).sort((a, b) => a.id.localeCompare(b.id)));
            isUpdatingPositions = false;
            return;
        }
        
        // åˆ›å»ºæ–°çš„æŒä»“æ˜ å°„
        const newPositionsMap = new Map();
        uniquePositions.forEach(pos => {
            newPositionsMap.set(pos.id, pos);
        });
        
        // æ›´æ–°ç°æœ‰è¡Œï¼ˆåªæ›´æ–°å˜åŒ–çš„å•å…ƒæ ¼ï¼‰
        const existingRows = new Map();
        Array.from(tbody.querySelectorAll('tr')).forEach(row => {
            const rowId = row.getAttribute('data-position-id');
            if (rowId && newPositionsMap.has(rowId)) {
                // åªä¿ç•™éœ€è¦æ›´æ–°çš„è¡Œ
                if (!existingRows.has(rowId)) {
                    existingRows.set(rowId, row);
                } else {
                    // å¦‚æœDOMä¸­æœ‰é‡å¤è¡Œï¼Œåˆ é™¤å¤šä½™çš„
                    row.remove();
                }
            } else if (rowId) {
                // åˆ é™¤ä¸å­˜åœ¨çš„è¡Œ
                row.remove();
            }
        });
        
        // æ›´æ–°æˆ–åˆ›å»ºè¡Œ
        uniquePositions.forEach((pos) => {
            let row = existingRows.get(pos.id);
            const lastPos = lastPositionsMap.get(pos.id);
            
            if (!row) {
                // æ–°è¡Œï¼šåˆ›å»ºå¹¶è¿½åŠ åˆ°æœ«å°¾
                row = createPositionRow(pos);
                tbody.appendChild(row);
            } else {
                // ç°æœ‰è¡Œï¼šåªæ›´æ–°å˜åŒ–çš„å•å…ƒæ ¼
                updatePositionRow(row, pos, lastPos);
            }
        });
        
        // æ›´æ–°ç¼“å­˜å’Œå¿«ç…§
        lastPositionsMap = newPositionsMap;
        currentDisplayedPositionIds = new Set(newPositionIds);
        lastPositionsSnapshot = JSON.stringify(uniquePositions.map(p => ({
            id: p.id,
            price: Math.round((p.current_price || 0) * 100) / 100,        // ä»·æ ¼ç²¾åº¦ï¼š0.01ï¼ˆå¸å®‰é£æ ¼ï¼‰
            pnlPct: Math.round((p.pnl_pct || 0) * 1000) / 1000,          // ç›ˆäºç™¾åˆ†æ¯”ç²¾åº¦ï¼š0.1%ï¼ˆå¸å®‰é£æ ¼ï¼‰
            pnlValue: Math.round((p.pnl_value || 0) * 100) / 100          // ç›ˆäºé‡‘é¢ç²¾åº¦ï¼š0.01 USDTï¼ˆå¸å®‰é£æ ¼ï¼‰
        })).sort((a, b) => a.id.localeCompare(b.id)));
        
        isUpdatingPositions = false;
    } catch (error) {
        console.error('æ›´æ–°æŒä»“æ—¶å‡ºé”™:', error);
        isUpdatingPositions = false;
    }
}

function renderHighLowText(pos) {
    const hasHigh = pos.highest_price !== null && pos.highest_price !== undefined;
    const hasLow = pos.lowest_price !== null && pos.lowest_price !== undefined;
    
    if (hasHigh && hasLow) {
        if (pos.side === 'BUY') {
            return `<span class="has-text-success">${formatNumber(pos.highest_price, 3)}</span> / ${formatNumber(pos.lowest_price, 3)}`;
        }
        return `${formatNumber(pos.highest_price, 3)} / <span class="has-text-danger">${formatNumber(pos.lowest_price, 3)}</span>`;
    }
    
    if (hasHigh) {
        return `<span class="has-text-success">${formatNumber(pos.highest_price, 3)}</span> / -`;
    }
    
    if (hasLow) {
        return `- / <span class="has-text-danger">${formatNumber(pos.lowest_price, 3)}</span>`;
    }
    
    return '-';
}

function renderTrailingStopPriceText(pos) {
    if (pos.trailing_stop_price === null || pos.trailing_stop_price === undefined) {
        return '-';
    }
    return formatNumber(pos.trailing_stop_price, 3);
}

function renderTrailingDistanceInfo(pos) {
    if (pos.trailing_stop_distance === null || pos.trailing_stop_distance === undefined) {
        return { text: '-', className: '' };
    }
    
    const distance = Number(pos.trailing_stop_distance);
    if (Number.isNaN(distance)) {
        return { text: '-', className: '' };
    }
    
    if (distance < 0) {
        return { text: `${formatNumber(Math.abs(distance), 3)} (å·²è§¦å‘)`, className: 'has-text-danger' };
    }
    
    if (distance === 0) {
        return { text: formatNumber(distance, 3), className: '' };
    }
    
    return { text: formatNumber(distance, 3), className: 'has-text-success' };
}

function renderStopTrailText(pos) {
    const stopLossPct = ((pos.stop_loss_pct ?? 0) * 100).toFixed(2);
    const trailingExitPct = ((pos.trailing_exit_pct ?? 0) * 100).toFixed(2);
    return `${stopLossPct}% / ${trailingExitPct}%`;
}

function renderPrincipalText(pos) {
    if (pos.principal !== null && pos.principal !== undefined) {
        return `${formatNumber(pos.principal, 3)} USDT`;
    }
    
    const priceValue = pos.entry_price ?? pos.entryPrice ?? null;
    const quantityValue = pos.quantity ?? pos.entry_quantity ?? null;
    
    if (priceValue !== null && priceValue !== undefined &&
        quantityValue !== null && quantityValue !== undefined) {
        const principal = Number(priceValue) * Number(quantityValue);
        if (!Number.isNaN(principal) && principal > 0) {
            return `${formatNumber(principal, 3)} USDT`;
        }
    }
    
    return '-';
}

// åˆ›å»ºæŒä»“è¡¨æ ¼
function createPositionsTable(container, positions) {
    const fragment = document.createDocumentFragment();
    const tableContainer = document.createElement('div');
    tableContainer.className = 'table-container';
    
    const table = document.createElement('table');
    table.className = 'table is-fullwidth is-striped is-hoverable is-narrow is-size-7';
    table.style.whiteSpace = 'nowrap';
    
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr>
            <th>äº¤æ˜“å¯¹ / Symbol</th>
            <th>æ–¹å‘ / Side</th>
            <th>å…¥åœºä»· / Entry</th>
            <th>å½“å‰ä»· / Current</th>
            <th>æ•°é‡ / Quantity</th>
            <th>æ æ† / Leverage</th>
            <th>æœ¬é‡‘ / Principal</th>
            <th>ç›ˆäº% / P&L %</th>
            <th>ç›ˆäºé‡‘é¢ / P&L Value</th>
            <th>æœ€é«˜/æœ€ä½ / High/Low</th>
            <th>è§¦å‘ä»· / Trigger</th>
            <th>è·ç¦» / Distance</th>
            <th>æ­¢æŸ/æ»‘åŠ¨% / Stop/Trail %</th>
            <th>æ“ä½œ / Actions</th>
        </tr>
    `;
    table.appendChild(thead);
    
    const tbody = document.createElement('tbody');
    positions.forEach(pos => {
        const row = createPositionRow(pos);
        tbody.appendChild(row);
    });
    table.appendChild(tbody);
    
    tableContainer.appendChild(table);
    fragment.appendChild(tableContainer);
    
    container.innerHTML = '';
    container.appendChild(fragment);
    positionsTable = table;
    lastPositionsMap = new Map(positions.map(p => [p.id, p]));
    currentDisplayedPositionIds = new Set(positions.map(p => p.id));
}

// åˆ›å»ºæŒä»“è¡Œï¼ˆå•è¡Œæ˜¾ç¤ºï¼Œä¿æŒç´§å‡‘ï¼‰
function createPositionRow(pos) {
    const row = document.createElement('tr');
    row.setAttribute('data-position-id', pos.id);
    
    const entryPriceText = pos.entry_price !== null && pos.entry_price !== undefined
        ? formatNumber(pos.entry_price, 3)
        : '-';
    const currentPriceText = pos.current_price !== null && pos.current_price !== undefined
        ? formatNumber(pos.current_price, 3)
        : '-';
    const quantityText = pos.quantity !== null && pos.quantity !== undefined
        ? formatNumber(pos.quantity, 3)
        : '-';
    const leverageText = pos.leverage !== null && pos.leverage !== undefined
        ? `${pos.leverage}x`
        : '-';
    const principalText = renderPrincipalText(pos);
    
    const hasPnlPct = pos.pnl_pct !== null && pos.pnl_pct !== undefined;
    const pnlValue = hasPnlPct ? Number(pos.pnl_pct) : 0;
    const pnlClass = hasPnlPct ? (pnlValue >= 0 ? 'has-text-success' : 'has-text-danger') : '';
    const pnlPctText = hasPnlPct ? formatPercent(pnlValue) : '-';
    
    const hasPnlAmount = pos.pnl_value !== null && pos.pnl_value !== undefined;
    const pnlAmountText = hasPnlAmount ? `${formatNumber(pos.pnl_value, 3)} USDT` : '-';
    
    const highLowText = renderHighLowText(pos);
    const trailingStopPriceText = renderTrailingStopPriceText(pos);
    const trailingDistanceInfo = renderTrailingDistanceInfo(pos);
    const stopTrailText = renderStopTrailText(pos);
    
    row.innerHTML = `
        <td data-field="symbol"><strong>${pos.symbol}</strong></td>
        <td data-field="side"><span class="tag ${pos.side === 'BUY' ? 'is-success' : 'is-danger'}">${pos.side}</span></td>
        <td data-field="entry_price">${entryPriceText}</td>
        <td data-field="current_price"><strong>${currentPriceText}</strong></td>
        <td data-field="quantity">${quantityText}</td>
        <td data-field="leverage">${leverageText}</td>
        <td data-field="principal">${principalText}</td>
        <td data-field="pnl_pct" class="${pnlClass}"><strong>${pnlPctText}</strong></td>
        <td data-field="pnl_value" class="${pnlClass}"><strong>${pnlAmountText}</strong></td>
        <td data-field="high_low">${highLowText}</td>
        <td data-field="trailing_stop_price">${trailingStopPriceText}</td>
        <td data-field="trailing_stop_distance" class="${trailingDistanceInfo.className || ''}">${trailingDistanceInfo.text}</td>
        <td data-field="stop_trail_pct">${stopTrailText}</td>
        <td data-field="actions">
            <button class="button is-small is-info" onclick="editExitParams('${pos.id}', '${pos.symbol}', ${pos.stop_loss_pct}, ${pos.trailing_exit_pct})">
                ç¼–è¾‘ / Edit
            </button>
        </td>
    `;
    
    return row;
}

// æ›´æ–°æŒä»“è¡Œï¼šé‡æ–°æ¸²æŸ“å•è¡Œï¼Œä¿æŒæœ€æ–°å¸ƒå±€
function updatePositionRow(row, pos) {
    const newRow = createPositionRow(pos);
    row.innerHTML = newRow.innerHTML;
}

// è¿æ¥WebSocket
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/api/ws/realtime`;
    
    try {
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            console.log('WebSocketè¿æ¥å·²å»ºç«‹ï¼Œåˆ‡æ¢åˆ°æ··åˆæ¨¡å¼ï¼ˆWebSocketæ¨é€æŒä»“å’ŒPnLï¼ŒHTTPè½®è¯¢ä½™é¢å’Œæ‰‹åŠ¨è®¡åˆ’ï¼‰');
            wsReconnectAttempts = 0;
            
            // WebSocketè¿æ¥åï¼Œè°ƒæ•´HTTPè½®è¯¢é¢‘ç‡ä¸º3ç§’ï¼ˆåªæ›´æ–°ä½™é¢å’Œæ‰‹åŠ¨è®¡åˆ’ï¼‰
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            currentRefreshRate = HTTP_REFRESH_RATE_WS_CONNECTED;
            refreshInterval = setInterval(refreshDashboard, currentRefreshRate);
            
            // ç«‹å³åˆ·æ–°ä¸€æ¬¡ï¼ˆè·å–ä½™é¢å’Œæ‰‹åŠ¨è®¡åˆ’ï¼‰
            refreshDashboard();
        };
        
        ws.onmessage = function(event) {
            try {
                const message = JSON.parse(event.data);
                if (message.type === 'positions_update') {
                    // è®°å½•WebSocketæ›´æ–°æ—¶é—´
                    lastWebSocketUpdateTime = Date.now();
                    
                    // å»é‡ï¼šç¡®ä¿WebSocketæ¨é€çš„æŒä»“æ•°æ®æ²¡æœ‰é‡å¤
                    const positions = message.data.positions || [];
                    const uniquePositions = [];
                    const seenIds = new Set();
                    for (const pos of positions) {
                        if (!seenIds.has(pos.id)) {
                            seenIds.add(pos.id);
                            uniquePositions.push(pos);
                        } else {
                            console.warn('WebSocketæ¨é€çš„æŒä»“æ•°æ®æœ‰é‡å¤IDï¼ˆå·²è¿‡æ»¤ï¼‰:', pos.id, pos.symbol);
                        }
                    }
                    
                    // å®æ—¶æ›´æ–°æŒä»“æ•°æ®ï¼ˆæ¥è‡ªWebSocketï¼Œä¼˜å…ˆçº§é«˜äºHTTPè½®è¯¢ï¼‰
                    // WebSocketæ˜¯ä¸»è¦æ•°æ®æºï¼Œç›´æ¥æ›´æ–°
                    updatePositions(uniquePositions);
                    // åŒæ—¶æ›´æ–°PnLï¼ˆæ¥è‡ªWebSocketï¼Œä½¿ç”¨ç»Ÿä¸€å‡½æ•°é¿å…å†²çªï¼‰
                    if (message.data.total_pnl !== undefined) {
                        updatePnlValue(message.data.total_pnl, 'websocket');
                    }
                    // æ›´æ–°æŒä»“æ•°é‡ï¼ˆä½¿ç”¨å»é‡åçš„æ•°é‡ï¼‰
                    const countElement = document.getElementById('position-count');
                    if (countElement) {
                        countElement.textContent = uniquePositions.length || 0;
                    }
                }
            } catch (error) {
                console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', error);
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocketé”™è¯¯:', error);
        };
        
        ws.onclose = function() {
            console.log('WebSocketè¿æ¥å·²æ–­å¼€ï¼Œåˆ‡æ¢åˆ°å®Œæ•´HTTPè½®è¯¢æ¨¡å¼ï¼ˆfallbackï¼‰');
            ws = null;
            
            // WebSocketæ–­å¼€åï¼Œåˆ‡æ¢åˆ°å®Œæ•´HTTPè½®è¯¢æ¨¡å¼ï¼ˆ1ç§’ï¼Œæ›´æ–°æ‰€æœ‰æ•°æ®ï¼‰
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            currentRefreshRate = HTTP_REFRESH_RATE_WS_DISCONNECTED;
            refreshInterval = setInterval(refreshDashboard, currentRefreshRate);
            
            // ç«‹å³åˆ·æ–°ä¸€æ¬¡ï¼ˆè·å–æ‰€æœ‰æ•°æ®ï¼‰
            refreshDashboard();
            
            // å°è¯•é‡è¿
            if (wsReconnectAttempts < MAX_WS_RECONNECT_ATTEMPTS) {
                wsReconnectAttempts++;
                setTimeout(connectWebSocket, 2000 * wsReconnectAttempts); // æŒ‡æ•°é€€é¿
            } else {
                console.warn('WebSocketé‡è¿æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œä½¿ç”¨å®Œæ•´HTTPè½®è¯¢æ¨¡å¼');
            }
        };
    } catch (error) {
        console.error('åˆ›å»ºWebSocketè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨å®Œæ•´HTTPè½®è¯¢æ¨¡å¼:', error);
        // ç¡®ä¿HTTPè½®è¯¢ç»§ç»­è¿è¡Œï¼ˆå¦‚æœå®šæ—¶å™¨ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
        if (!refreshInterval) {
            currentRefreshRate = HTTP_REFRESH_RATE_WS_DISCONNECTED;
            refreshInterval = setInterval(refreshDashboard, currentRefreshRate);
        }
    }
}

// æ›´æ–°æ‰‹åŠ¨è®¡åˆ’è¡¨
async function updateManualPlans() {
    try {
        const timestamp = new Date().getTime();
        const response = await fetch(`/api/manual-plans?t=${timestamp}`, {
            method: 'GET',
            cache: 'no-cache',
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        });
        const plans = await response.json();
        
        const container = document.getElementById('manual-plans-container');
        const countElement = document.getElementById('manual-plans-count');
        
        if (countElement) {
            countElement.textContent = plans.length;
        }
        
        if (plans.length === 0) {
            container.innerHTML = '<p>æš‚æ— æ‰‹åŠ¨è®¡åˆ’ / No manual plans</p>';
            return;
        }
        
        let html = '<table class="table is-fullwidth is-striped is-narrow">';
        html += '<thead><tr>';
        html += '<th>ç¬¦å· / Symbol</th><th>æ–¹å‘ / Side</th><th>ä¸Šçº¿æ—¶é—´ / Listing Time</th>';
        html += '<th>æ æ† / Leverage</th><th>ä»“ä½% / Position %</th><th>çŠ¶æ€ / Status</th><th>æ“ä½œ / Action</th>';
        html += '</tr></thead><tbody>';
        
        plans.forEach(plan => {
            // å¤„ç†çŠ¶æ€ï¼ˆå¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–å¯¹è±¡ï¼‰
            const status = typeof plan.status === 'string' ? plan.status : (plan.status?.value || plan.status || 'PENDING');
            const canCancel = ['PENDING', 'ARMED', 'EXECUTING'].includes(status);
            
            // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
            let listingTime = '';
            if (plan.listing_time) {
                try {
                    const date = new Date(plan.listing_time);
                    listingTime = date.toLocaleString('zh-CN', { timeZone: 'UTC' }) + ' UTC';
                } catch (e) {
                    listingTime = plan.listing_time;
                }
            }
            
            html += '<tr>';
            html += `<td>${plan.symbol || ''}</td>`;
            html += `<td>${plan.side || ''}</td>`;
            html += `<td>${listingTime}</td>`;
            html += `<td>${plan.leverage || ''}</td>`;
            html += `<td>${plan.position_pct || ''}</td>`;
            html += `<td>${status}</td>`;
            html += '<td>';
            if (canCancel) {
                html += `<form method="post" action="/manual-plans/${plan.id}/cancel">`;
                html += '<button class="button is-small is-light" type="submit">å–æ¶ˆ / Cancel</button>';
                html += '</form>';
            } else {
                html += '-';
            }
            html += '</td>';
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    } catch (error) {
        console.error('æ›´æ–°æ‰‹åŠ¨è®¡åˆ’è¡¨å¤±è´¥:', error);
    }
}

// åˆ·æ–°è´¦æˆ·ä¿¡æ¯ï¼ˆå·²åºŸå¼ƒï¼Œç°åœ¨ç»Ÿä¸€ä½¿ç”¨ refreshDashboardï¼‰
async function refreshAccountInfo() {
    // ä¸ºäº†å…¼å®¹æ€§ä¿ç•™ï¼Œä½†å®é™…è°ƒç”¨ refreshDashboard
    await refreshDashboard();
}

// åˆ·æ–°ä»ªè¡¨ç›˜æ•°æ®ï¼ˆæ··åˆæ¨¡å¼ï¼šWebSocketæ¨é€æŒä»“å’ŒPnLï¼ŒHTTPè½®è¯¢ä½™é¢å’Œæ‰‹åŠ¨è®¡åˆ’ï¼‰
let isRefreshing = false; // é˜²æ­¢å¹¶å‘åˆ·æ–°
let lastRefreshTime = 0; // ä¸Šæ¬¡åˆ·æ–°æ—¶é—´
const MIN_REFRESH_INTERVAL = 100; // æœ€å°åˆ·æ–°é—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œé˜²æ­¢è¿‡äºé¢‘ç¹

async function refreshDashboard() {
    // é˜²æ­¢å¹¶å‘åˆ·æ–°
    if (isRefreshing) {
        return;
    }
    
    const wsConnected = ws && ws.readyState === WebSocket.OPEN;
    
    // æ ¹æ®WebSocketè¿æ¥çŠ¶æ€è°ƒæ•´æœ€å°åˆ·æ–°é—´éš”
    const minInterval = wsConnected ? 500 : MIN_REFRESH_INTERVAL; // WebSocketè¿æ¥æ—¶ï¼ŒHTTPè½®è¯¢é—´éš”æ›´å¤§
    
    // èŠ‚æµï¼šç¡®ä¿åˆ·æ–°é—´éš”ä¸å°äºæœ€å°å€¼
    const now = Date.now();
    if (now - lastRefreshTime < minInterval) {
        return;
    }
    lastRefreshTime = now;
    
    isRefreshing = true;
    try {
        // æ·»åŠ æ—¶é—´æˆ³å’Œcacheæ§åˆ¶ï¼Œé˜²æ­¢æµè§ˆå™¨ç¼“å­˜
        const timestamp = new Date().getTime();
        const response = await fetch(`/api/realtime/dashboard?t=${timestamp}`, {
            method: 'GET',
            cache: 'no-cache',
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        const wsConnected = ws && ws.readyState === WebSocket.OPEN;
        
        if (wsConnected) {
            // WebSocketå·²è¿æ¥ï¼šæ··åˆæ¨¡å¼
            // æ›´æ–°ä½™é¢å’Œæ‰‹åŠ¨è®¡åˆ’ï¼ˆæŒä»“å’ŒPnLä¸»è¦ç”±WebSocketæ¨é€ï¼ŒHTTPä½œä¸ºfallbackï¼‰
            updateAccountInfo({
                account: {
                    spot_balance: data.account.spot_balance,
                    wallet_balance: data.account.wallet_balance,
                    futures_balance: data.account.futures_balance,
                    // total_pnl ä¸æ›´æ–°ï¼Œç”±WebSocketå¤„ç†
                },
                position_count: data.position_count  // æŒä»“æ•°é‡ç”±HTTPæ›´æ–°ï¼ˆä½œä¸ºè¡¥å……ï¼‰
            });
            
            // æ›´æ–°æ‰‹åŠ¨è®¡åˆ’è¡¨ï¼ˆä½é¢‘ï¼Œ1ç§’ä¸€æ¬¡ï¼‰
            await updateManualPlans();
            
            // WebSocketè¿æ¥æ—¶ï¼ŒHTTPè½®è¯¢ä¹Ÿä½œä¸ºfallbackæ›´æ–°æŒä»“ï¼ˆä½†é¢‘ç‡è¾ƒä½ï¼Œ2ç§’ä¸€æ¬¡ï¼‰
            // è¿™æ ·å¯ä»¥ç¡®ä¿å³ä½¿WebSocketæ¨é€æœ‰é—®é¢˜ï¼ŒæŒä»“ä¹Ÿèƒ½æ›´æ–°
            if (data.positions && data.positions.length > 0) {
                // åªæœ‰åœ¨WebSocketå¯èƒ½æœ‰é—®é¢˜æ—¶æ‰é€šè¿‡HTTPæ›´æ–°ï¼ˆä½œä¸ºfallbackï¼‰
                // æ£€æŸ¥ä¸Šæ¬¡WebSocketæ›´æ–°æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡3ç§’æ²¡æœ‰æ›´æ–°ï¼Œåˆ™ä½¿ç”¨HTTPæ•°æ®
                const now = Date.now();
                if (!lastWebSocketUpdateTime || (now - lastWebSocketUpdateTime > 3000)) {
                    console.log('WebSocketå¯èƒ½æœ‰é—®é¢˜ï¼Œä½¿ç”¨HTTPæ•°æ®ä½œä¸ºfallbackæ›´æ–°æŒä»“');
                    updatePositions(data.positions);
                }
            }
            
            // WebSocketè¿æ¥æ—¶ï¼ŒHTTPè½®è¯¢é¢‘ç‡å›ºå®šä¸º2ç§’ï¼ˆæ›´æ–°ä½™é¢å’Œæ‰‹åŠ¨è®¡åˆ’ï¼Œå¿…è¦æ—¶æ›´æ–°æŒä»“ï¼‰
            const targetRefreshRate = 2000; // 2ç§’ï¼Œé™ä½HTTPè½®è¯¢é¢‘ç‡
            if (currentRefreshRate !== targetRefreshRate) {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
                currentRefreshRate = targetRefreshRate;
                refreshInterval = setInterval(refreshDashboard, currentRefreshRate);
                console.log(`æ··åˆæ¨¡å¼ï¼šWebSocketå·²è¿æ¥ï¼ŒHTTPè½®è¯¢é¢‘ç‡è°ƒæ•´ä¸º ${currentRefreshRate}msï¼ˆæ›´æ–°ä½™é¢å’Œæ‰‹åŠ¨è®¡åˆ’ï¼Œå¿…è¦æ—¶æ›´æ–°æŒä»“ï¼‰`);
            }
        } else {
            // WebSocketæœªè¿æ¥ï¼šå®Œæ•´HTTPè½®è¯¢æ¨¡å¼ï¼ˆfallbackï¼‰
            // æ›´æ–°æ‰€æœ‰æ•°æ®ï¼ˆä½™é¢ã€æŒä»“ã€PnLã€æ‰‹åŠ¨è®¡åˆ’ï¼‰
            updateAccountInfo(data);
            // åªæœ‰åœ¨WebSocketæœªè¿æ¥æ—¶æ‰é€šè¿‡HTTPæ›´æ–°æŒä»“ï¼ˆHTTPæ˜¯å”¯ä¸€æ•°æ®æºï¼‰
            updatePositions(data.positions || []);
            await updateManualPlans();
            
            // åŠ¨æ€è°ƒæ•´åˆ·æ–°é¢‘ç‡ï¼ˆåªåœ¨WebSocketæœªè¿æ¥æ—¶è°ƒæ•´ï¼‰
            const hasPositions = (data.positions || []).length > 0;
            const hasUpcomingTrade = data.has_upcoming_trade || false;
            
            // å¦‚æœæœ‰æŒä»“æˆ–ä¸´è¿‘äº¤æ˜“ï¼ˆ1åˆ†é’Ÿå†…ï¼‰ï¼Œä½¿ç”¨é«˜é¢‘åˆ·æ–°ï¼ˆ200msï¼‰
            // å¦åˆ™ä½¿ç”¨æ­£å¸¸åˆ·æ–°ï¼ˆ1ç§’ï¼‰
            const shouldUseHighFreq = hasPositions || hasUpcomingTrade;
            const newRefreshRate = shouldUseHighFreq ? HIGH_FREQ_RATE : NORMAL_RATE;
            
            // å¦‚æœåˆ·æ–°é¢‘ç‡å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°è®¾ç½®å®šæ—¶å™¨
            if (newRefreshRate !== currentRefreshRate) {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
                currentRefreshRate = newRefreshRate;
                refreshInterval = setInterval(refreshDashboard, currentRefreshRate);
                console.log(`å®Œæ•´HTTPæ¨¡å¼ï¼šåˆ·æ–°é¢‘ç‡å·²è°ƒæ•´ä¸º ${currentRefreshRate}ms (${shouldUseHighFreq ? 'é«˜é¢‘æ¨¡å¼' : 'æ­£å¸¸æ¨¡å¼'})`);
            }
        }
    } catch (error) {
        console.error('åˆ·æ–°å¤±è´¥:', error);
        // åªåœ¨å‡ºé”™æ—¶æ˜¾ç¤ºé”™è¯¯ï¼Œä¸è¦è¦†ç›–æ­£å¸¸å†…å®¹
        const container = document.getElementById('positions-container');
        if (container && (container.innerHTML.includes('åŠ è½½ä¸­') || container.innerHTML.trim() === '')) {
            container.innerHTML = '<p class="has-text-danger">åˆ·æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ / Refresh failed, please check network connection</p>';
        }
    } finally {
        isRefreshing = false;
    }
}

// é¡µé¢åŠ è½½æ—¶å¼€å§‹è‡ªåŠ¨åˆ·æ–°
document.addEventListener('DOMContentLoaded', function() {
    updateUTCTime();
    
    // åˆå§‹åŒ–åˆ·æ–°å®šæ—¶å™¨ï¼ˆé»˜è®¤1ç§’ï¼ŒWebSocketè¿æ¥åä¼šè°ƒæ•´ä¸º3ç§’ï¼‰
    if (!refreshInterval) {
        currentRefreshRate = HTTP_REFRESH_RATE_WS_DISCONNECTED; // åˆå§‹ä½¿ç”¨å®Œæ•´HTTPæ¨¡å¼
        refreshInterval = setInterval(refreshDashboard, currentRefreshRate);
    }
    
    // ç«‹å³åˆ·æ–°ä¸€æ¬¡æ•´ä¸ªDashboardï¼ˆåŒ…æ‹¬è´¦æˆ·ä¿¡æ¯ã€æŒä»“ã€æ‰‹åŠ¨è®¡åˆ’è¡¨ï¼‰
    refreshDashboard();
    
    // åŠ è½½é…ç½®
    loadSettings();
    
    // å°è¯•è¿æ¥WebSocketï¼ˆå®æ—¶æ¨é€æŒä»“å’ŒPnLæ•°æ®ï¼‰
    connectWebSocket();
    
    // åŠ è½½æ”¶ç›Šæ‘˜è¦å¹¶å®šæœŸåˆ·æ–°
    loadPnlSummary();
    pnlRefreshTimer = setInterval(() => loadPnlSummary(), PNL_REFRESH_INTERVAL);
    
    // æ¯1ç§’æ›´æ–°UTCæ—¶é—´ï¼ˆå®æ—¶æ˜¾ç¤ºï¼ŒåŒ…å«ç§’ï¼‰
    setInterval(updateUTCTime, 1000);
});

// é¡µé¢å¸è½½æ—¶æ¸…ç†
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
    if (pnlRefreshTimer) {
        clearInterval(pnlRefreshTimer);
    }
    if (ws) {
        ws.close();
    }
});

// åŠ è½½é…ç½®
async function loadSettings() {
    try {
        const response = await fetch('/api/settings');
        const settings = await response.json();
        
        // å¡«å……è¡¨å•
        document.getElementById('order_type').value = settings.order_type || 'MARKET';
        document.getElementById('max_slippage_pct').value = settings.max_slippage_pct || 0.5;
        document.getElementById('limit_order_timeout_seconds').value = settings.limit_order_timeout_seconds || 30;
        document.getElementById('max_order_amount').value = settings.max_order_amount || '';
        document.getElementById('leverage').value = settings.leverage || 5;
        document.getElementById('position_pct').value = settings.position_pct || 0.5;
        document.getElementById('trailing_exit_pct').value = settings.trailing_exit_pct || 0.15;
        document.getElementById('stop_loss_pct').value = settings.stop_loss_pct || 0.05;
        
        showMessage('é…ç½®å·²åŠ è½½ / Settings loaded', 'is-success');
    } catch (error) {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
        showMessage('åŠ è½½é…ç½®å¤±è´¥ / Failed to load settings', 'is-danger');
    }
}

// æ›´æ–°é…ç½®
async function updateSettings(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const data = {};
    
    // æ”¶é›†è¡¨å•æ•°æ®
    for (const [key, value] of formData.entries()) {
        if (value !== '') {
            if (key === 'order_type') {
                data[key] = value;
            } else if (key === 'max_order_amount') {
                // ç©ºå€¼æˆ–0è¡¨ç¤ºä¸é™åˆ¶
                const numValue = parseFloat(value);
                data[key] = isNaN(numValue) || numValue === 0 ? null : numValue;
            } else {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    data[key] = numValue;
                }
            }
        }
    }
    
    try {
        const response = await fetch('/api/settings', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage(result.message + ' ' + (result.warning || ''), 'is-warning');
            // æ›´æ–°æˆåŠŸåï¼Œç«‹å³åˆ·æ–°é…ç½®æ˜¾ç¤ºï¼ˆä¸éœ€è¦é‡å¯æœåŠ¡ï¼Œå› ä¸ºå·²æ›´æ–° os.environï¼‰
            await loadSettings();
            // åŒæ—¶åˆ·æ–°é¡µé¢ä»¥æ›´æ–°æ‰‹åŠ¨è®¡åˆ’è¡¨å•çš„é»˜è®¤å€¼
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showMessage(result.message || 'æ›´æ–°å¤±è´¥ / Update failed', 'is-danger');
        }
    } catch (error) {
        console.error('æ›´æ–°é…ç½®å¤±è´¥:', error);
        showMessage('æ›´æ–°é…ç½®å¤±è´¥ / Failed to update settings', 'is-danger');
    }
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(message, type) {
    const messageEl = document.getElementById('settings-message');
    messageEl.textContent = message;
    messageEl.className = `notification ${type}`;
    messageEl.style.display = 'block';
    
    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        messageEl.style.display = 'none';
    }, 3000);
}

// ç¼–è¾‘é€€å‡ºå‚æ•°ç›¸å…³å‡½æ•°
let currentEditingPositionId = null;

function editExitParams(positionId, symbol, stopLossPct, trailingExitPct) {
    currentEditingPositionId = positionId;
    document.getElementById('edit-symbol').value = symbol;
    document.getElementById('edit-stop-loss-pct').value = (stopLossPct * 100).toFixed(2);
    document.getElementById('edit-trailing-exit-pct').value = (trailingExitPct * 100).toFixed(2);
    document.getElementById('edit-exit-params-modal').classList.add('is-active');
}

function closeEditExitParamsModal() {
    document.getElementById('edit-exit-params-modal').classList.remove('is-active');
    currentEditingPositionId = null;
}

async function saveExitParams() {
    if (!currentEditingPositionId) {
        alert('é”™è¯¯ï¼šæœªé€‰æ‹©æŒä»“ / Error: No position selected');
        return;
    }
    
    const stopLossPctInput = document.getElementById('edit-stop-loss-pct');
    const trailingExitPctInput = document.getElementById('edit-trailing-exit-pct');
    
    const stopLossPct = parseFloat(stopLossPctInput.value);
    const trailingExitPct = parseFloat(trailingExitPctInput.value);
    
    // éªŒè¯è¾“å…¥
    if (isNaN(stopLossPct) || stopLossPct < 0 || stopLossPct > 100) {
        alert('æ­¢æŸç™¾åˆ†æ¯”å¿…é¡»åœ¨0-100ä¹‹é—´ / Stop loss percentage must be between 0 and 100');
        return;
    }
    
    if (isNaN(trailingExitPct) || trailingExitPct < 0 || trailingExitPct > 100) {
        alert('æ»‘åŠ¨é€€å‡ºç™¾åˆ†æ¯”å¿…é¡»åœ¨0-100ä¹‹é—´ / Trailing exit percentage must be between 0 and 100');
        return;
    }
    
    // è½¬æ¢ä¸º0-1ä¹‹é—´çš„å€¼
    const stopLossPctDecimal = stopLossPct / 100;
    const trailingExitPctDecimal = trailingExitPct / 100;
    
    try {
        const response = await fetch(`/api/positions/${currentEditingPositionId}/exit-params`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                stop_loss_pct: stopLossPctDecimal,
                trailing_exit_pct: trailingExitPctDecimal,
            }),
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            alert('é€€å‡ºå‚æ•°å·²æ›´æ–° / Exit parameters updated successfully');
            closeEditExitParamsModal();
            // åˆ·æ–°æŒä»“æ•°æ®
            if (ws && ws.readyState === WebSocket.OPEN) {
                // WebSocketä¼šè‡ªåŠ¨æ›´æ–°
            } else {
                refreshDashboard();
            }
        } else {
            alert('æ›´æ–°å¤±è´¥ / Update failed: ' + (data.detail || data.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('ä¿å­˜é€€å‡ºå‚æ•°å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ / Save failed, please check network connection');
    }
}
</script>

<!-- ç¼–è¾‘é€€å‡ºå‚æ•°æ¨¡æ€æ¡† / Edit Exit Parameters Modal -->
<div class="modal" id="edit-exit-params-modal">
    <div class="modal-background" onclick="closeEditExitParamsModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">ç¼–è¾‘é€€å‡ºå‚æ•° / Edit Exit Parameters</p>
            <button class="delete" aria-label="close" onclick="closeEditExitParamsModal()"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">äº¤æ˜“å¯¹ / Symbol</label>
                <p class="control">
                    <input class="input" type="text" id="edit-symbol" readonly>
                </p>
            </div>
            <div class="field">
                <label class="label">æ­¢æŸç™¾åˆ†æ¯” / Stop Loss %</label>
                <p class="control">
                    <input class="input" type="number" id="edit-stop-loss-pct" step="0.01" min="0" max="100" placeholder="ä¾‹å¦‚: 5 è¡¨ç¤º 5%">
                </p>
                <p class="help">ä»å…¥åœºä»·ä¸‹è·Œçš„ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰</p>
            </div>
            <div class="field">
                <label class="label">æ»‘åŠ¨é€€å‡ºç™¾åˆ†æ¯” / Trailing Exit %</label>
                <p class="control">
                    <input class="input" type="number" id="edit-trailing-exit-pct" step="0.01" min="0" max="100" placeholder="ä¾‹å¦‚: 15 è¡¨ç¤º 15%">
                </p>
                <p class="help">ä»æœ€é«˜ä»·ï¼ˆåšå¤šï¼‰æˆ–æœ€ä½ä»·ï¼ˆåšç©ºï¼‰å›æ’¤çš„ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰</p>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" onclick="saveExitParams()">ä¿å­˜ / Save</button>
            <button class="button" onclick="closeEditExitParamsModal()">å–æ¶ˆ / Cancel</button>
        </footer>
    </div>
</div>
{% endblock %}

