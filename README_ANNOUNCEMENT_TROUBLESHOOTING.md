# 公告数据收集问题排查指南

## 问题：仪表盘中没有公告数据

### 可能的原因和解决方案

#### 1. **API端点问题（最常见）**

币安API可能已经更新，导致404或403错误。

**检查方法：**
```bash
# 运行测试脚本
python test_binance_api_direct.py
```

**解决方案：**
- 如果返回404：需要更新API端点URL
- 如果返回403：可能是代理问题或需要更新请求头

#### 2. **代理配置问题**

如果使用代理（Clash等），需要确保：
- `.env` 文件中配置了正确的 `HTTP_PROXY`
- 代理服务正在运行
- 代理可以访问币安网站

**检查方法：**
```bash
# 检查代理是否可用
curl -x http://127.0.0.1:7890 https://www.binance.com
```

#### 3. **调度器未启动**

公告抓取任务每90秒自动运行一次，如果调度器未启动，则不会抓取。

**检查方法：**
- 查看服务启动日志，应该看到 "初始化数据库并启动调度器…"
- 查看日志中是否有 "新增公告 X 条" 的消息

#### 4. **网络连接问题**

**检查方法：**
```bash
# 测试网络连接
ping www.binance.com
```

#### 5. **数据库问题**

**检查方法：**
- 查看数据库连接是否正常
- 查看数据库中是否有 `announcements_codex` 表
- 检查表结构是否正确

### 快速解决方案

#### 方案1：手动触发抓取

在仪表盘中点击 **"立即抓取 / Fetch Now"** 按钮，或使用API：

```bash
curl -X POST http://localhost:8000/api/announcements/fetch-now
```

#### 方案2：使用历史数据补抓

```bash
# 抓取最近1个月的历史公告
curl -X POST "http://localhost:8000/api/backfill/announcements?months=1&max_pages=10"
```

#### 方案3：检查并更新API端点

如果币安API已更新，需要：
1. 访问币安官网，查看公告页面的实际API端点
2. 更新 `.env` 文件中的 `ALPHA_FEED_URL` 和 `FUTURES_FEED_URL`
3. 重启服务

### 调试步骤

1. **检查服务日志**
   - 查看终端输出中的错误信息
   - 查找 "无法获取"、"抓取失败" 等关键词

2. **测试API连接**
   ```bash
   python test_announcement_fetch.py
   ```

3. **检查数据库**
   ```bash
   # 查询公告数量
   curl http://localhost:8000/api/announcements | python -m json.tool
   ```

4. **检查调度器状态**
   - 查看日志中是否有调度器启动信息
   - 检查是否有定时任务执行日志

### 常见错误

#### 错误1: 404 Not Found
- **原因**: API端点不存在或已更改
- **解决**: 更新API URL配置

#### 错误2: 403 Forbidden  
- **原因**: 访问被禁止，可能是代理问题
- **解决**: 检查代理配置，或尝试不使用代理

#### 错误3: Connection Error
- **原因**: 网络连接问题
- **解决**: 检查网络连接和代理设置

#### 错误4: 没有新公告
- **原因**: 所有公告都已抓取过（基于source_id去重）
- **解决**: 这是正常的，等待新公告发布

### 联系支持

如果以上方法都无法解决问题，请：
1. 收集完整的错误日志
2. 运行 `test_binance_api_direct.py` 并记录输出
3. 检查 `.env` 配置（隐藏敏感信息）

